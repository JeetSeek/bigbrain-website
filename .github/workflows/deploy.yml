name: Deploy BoilerBrain

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-backend:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd server
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          railway up --detach
      
      - name: Get Railway URL
        id: railway-url
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd server
          BACKEND_URL=$(railway domain)
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend deployed to: $BACKEND_URL"
    
    outputs:
      backend_url: ${{ steps.railway-url.outputs.backend_url }}

  deploy-frontend:
    name: Deploy Frontend to Netlify
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Update API URLs
        run: |
          BACKEND_URL="${{ needs.deploy-backend.outputs.backend_url }}"
          
          # Update http.js
          sed -i "s|http://localhost:3204|https://$BACKEND_URL|g" src/utils/http.js
          
          # Update MessageBubble.jsx
          sed -i "s|http://localhost:3204|https://$BACKEND_URL|g" src/components/chat/MessageBubble.jsx
          
          echo "Updated frontend to use backend: https://$BACKEND_URL"
      
      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: './dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 5
      
      - name: Update Railway CORS
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd server
          FRONTEND_URL="${{ secrets.NETLIFY_SITE_URL }}"
          railway variables set ALLOWED_ORIGINS="$FRONTEND_URL"
          echo "Updated CORS to allow: $FRONTEND_URL"

  notify:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          echo "ðŸŽ‰ Deployment Complete!"
          echo "Backend: https://${{ needs.deploy-backend.outputs.backend_url }}"
          echo "Frontend: ${{ secrets.NETLIFY_SITE_URL }}"
